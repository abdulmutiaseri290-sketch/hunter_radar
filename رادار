import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';
import 'dart:async';

void main() => runApp(const HunterApp());

class HunterApp extends StatefulWidget {
  const HunterApp({super.key});
  @override
  State<HunterApp> createState() => _HunterAppState();
}

class _HunterAppState extends State<HunterApp> {
  bool isLoggedIn = false;
  String? savedPin;

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Real Hunter Radar',
      theme: ThemeData.dark().copyWith(
        scaffoldBackgroundColor: const Color(0xFF020202),
        useMaterial3: true,
      ),
      home: isLoggedIn 
          ? Dashboard(onLogout: () => setState(() => isLoggedIn = false)) 
          : SetupPinGate(onComplete: (pin) => setState(() { savedPin = pin; isLoggedIn = true; })),
    );
  }
}

// --- شاشة إنشاء وتأكيد الرمز السري ---
class SetupPinGate extends StatefulWidget {
  final Function(String) onComplete;
  const SetupPinGate({super.key, required this.onComplete});
  @override
  State<SetupPinGate> createState() => _SetupPinGateState();
}

class _SetupPinGateState extends State<SetupPinGate> {
  String tempPin = "";
  bool isConfirming = false;
  String confirmPin = "";

  void _press(String n) {
    setState(() {
      if (!isConfirming) {
        if (tempPin.length < 6) tempPin += n;
        if (tempPin.length == 6) isConfirming = true;
      } else {
        if (confirmPin.length < 6) confirmPin += n;
        if (confirmPin.length == 6) {
          if (tempPin == confirmPin) widget.onComplete(tempPin);
          else { 
            tempPin = ""; confirmPin = ""; isConfirming = false;
            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("الرمز غير متطابق، حاول مجدداً")));
          }
        }
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    String display = isConfirming ? confirmPin : tempPin;
    return Scaffold(
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.security, size: 60, color: Colors.red),
            const SizedBox(height: 20),
            Text(isConfirming ? "تأكيد الرمز السري" : "أنشئ رمز دخول رادار الصياد", 
                style: const TextStyle(color: Colors.white, fontSize: 18)),
            const SizedBox(height: 30),
            Row(
              mainAxisAlignment: MainAxisAlignment.center, 
              children: List.generate(6, (i) => Container(
                margin: const EdgeInsets.all(5), 
                width: 12, height: 12, 
                decoration: BoxDecoration(shape: BoxShape.circle, color: i < display.length ? Colors.red : Colors.white10)
              ))),
            const SizedBox(height: 40),
            GridView.count(
              shrinkWrap: true, crossAxisCount: 3, padding: const EdgeInsets.symmetric(horizontal: 80),
              childAspectRatio: 1.5, physics: const NeverScrollableScrollPhysics(),
              children: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "⌫", "0", "C"].map((e) => InkWell(
                onTap: () {
                  if (e == "⌫") {
                    setState(() {
                      if(isConfirming) { if(confirmPin.isNotEmpty) confirmPin = confirmPin.substring(0, confirmPin.length-1); }
                      else { if(tempPin.isNotEmpty) tempPin = tempPin.substring(0, tempPin.length-1); }
                    });
                  } else if (e == "C") {
                    setState(() { tempPin = ""; confirmPin = ""; isConfirming = false; });
                  } else if (e != "") _press(e);
                },
                child: Center(child: Text(e, style: const TextStyle(fontSize: 24, color: Colors.red, fontWeight: FontWeight.bold))),
              )).toList(),
            ),
          ],
        ),
      ),
    );
  }
}

// --- لوحة التحكم الرئيسية ---
class Dashboard extends StatefulWidget {
  final VoidCallback onLogout;
  const Dashboard({super.key, required this.onLogout});
  @override
  State<Dashboard> createState() => _DashboardState();
}

class _DashboardState extends State<Dashboard> with TickerProviderStateMixin {
  bool isPTT = false;
  late AnimationController _mapCtrl;

  final List<Map<String, String>> friends = [
    {"name": "أبو أحمد", "loc": "24.7136,46.6753"},
    {"name": "فهد السبيعي", "loc": "24.4673,39.1862"},
    {"name": "سلطان", "loc": "21.4858,39.1925"},
  ];

  @override
  void initState() {
    super.initState();
    _mapCtrl = AnimationController(vsync: this, duration: const Duration(seconds: 4))..repeat();
  }

  @override
  void dispose() { _mapCtrl.dispose(); super.dispose(); }

  Future<void> _launchURL(String url) async {
    final Uri uri = Uri.parse(url);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      debugPrint("Could not launch $url");
    }
  }

  void _openNavigateMenu() {
    showModalBottomSheet(
      context: context,
      backgroundColor: const Color(0xFF1A1A1A),
      builder: (context) => ListView(
        shrinkWrap: true,
        padding: const EdgeInsets.all(20),
        children: [
          const Text("اختر رفيق الدرب للتوجه إليه", style: TextStyle(color: Colors.orangeAccent, fontSize: 18, fontWeight: FontWeight.bold)),
          ...friends.map((f) => ListTile(
            leading: const Icon(Icons.person_pin_circle, color: Colors.green),
            title: Text(f['name']!),
            onTap: () {
              Navigator.pop(context);
              _launchURL('https://www.google.com/maps/search/?api=1&query=${f['loc']}');
            },
          )),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.black,
        title: const Text("Real Hunter Radar", style: TextStyle(color: Colors.orangeAccent)),
        leading: IconButton(icon: const Icon(Icons.power_settings_new, color: Colors.red), onPressed: widget.onLogout),
        actions: [IconButton(icon: const Icon(Icons.shopping_cart, color: Colors.amber), onPressed: () => _launchURL('https://alsyyad.com/ar'))],
      ),
      body: Column(
        children: [
          const SizedBox(height: 10),
          _radioScreen(),
          _interactiveMap(),
          _bottomActions(),
        ],
      ),
    );
  }

  Widget _radioScreen() => Container(
    padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 15),
    decoration: BoxDecoration(color: const Color(0xFFC5D9A5), borderRadius: BorderRadius.circular(20)),
    child: Text(isPTT ? "إرسـال حـي" : "144.500 MHz", style: const TextStyle(fontSize: 22, color: Colors.black, fontWeight: FontWeight.bold)),
  );

  Widget _interactiveMap() => Expanded(
    child: Stack(
      alignment: Alignment.center,
      children: [
        RotationTransition(turns: _mapCtrl, child: Container(width: 280, height: 280, decoration: BoxDecoration(shape: BoxShape.circle, gradient: SweepGradient(colors: [Colors.transparent, isPTT ? Colors.red.withOpacity(0.2) : Colors.green.withOpacity(0.2), Colors.transparent])))),
        const Icon(Icons.navigation, color: Colors.orangeAccent, size: 50),
        Positioned(
          bottom: 30, right: 30,
          child: GestureDetector(
            onLongPress: () => _launchURL('https://wa.me/?text=فزعة!'),
            child: const CircleAvatar(radius: 30, backgroundColor: Colors.red, child: Text("فزعة", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold))),
          ),
        ),
      ],
    ),
  );

  Widget _bottomActions() => Padding(
    padding: const EdgeInsets.only(bottom: 30),
    child: Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: [
        _actionIcon(Icons.near_me, "اتجه إلي", Colors.blue, _openNavigateMenu),
        _pttBtn(),
        _actionIcon(Icons.map, "المسار", Colors.green, () {}),
      ],
    ),
  );

  Widget _pttBtn() => GestureDetector(
    onTapDown: (_) => setState(() => isPTT = true),
    onTapUp: (_) => setState(() => isPTT = false),
    child: CircleAvatar(radius: 40, backgroundColor: isPTT ? Colors.red : Colors.redAccent, child: Icon(isPTT ? Icons.settings_voice : Icons.mic, size: 40, color: Colors.white)),
  );

  Widget _actionIcon(IconData i, String l, Color c, VoidCallback t) => InkWell(onTap: t, child: Column(children: [Icon(i, color: c, size: 30), Text(l, style: const TextStyle(fontSize: 10))]));
}
