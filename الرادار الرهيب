import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';
import 'dart:async';

void main() {
  runApp(const HunterApp());
}

class HunterApp extends StatefulWidget {
  const HunterApp({super.key});
  @override
  State<HunterApp> createState() => _HunterAppState();
}

class _HunterAppState extends State<HunterApp> {
  bool isLoggedIn = false;

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Real Hunter Radar',
      theme: ThemeData.dark().copyWith(
        scaffoldBackgroundColor: const Color(0xFF020202),
        useMaterial3: true,
      ),
      home: isLoggedIn 
          ? const HunterDashboard() 
          : SetupPinGate(onComplete: () => setState(() => isLoggedIn = true)),
    );
  }
}

// --- شاشة الرمز السري المطور باللون الأحمر ---
class SetupPinGate extends StatefulWidget {
  final VoidCallback onComplete;
  const SetupPinGate({super.key, required this.onComplete});
  @override
  State<SetupPinGate> createState() => _SetupPinGateState();
}

class _SetupPinGateState extends State<SetupPinGate> {
  String pin = "";

  void _addDigit(String d) {
    if (pin.length < 6) setState(() => pin += d);
    if (pin.length == 6) widget.onComplete();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: SingleChildScrollView(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(Icons.radar, size: 80, color: Colors.red),
              const SizedBox(height: 20),
              const Text("أدخل رمز الدخول السري", style: TextStyle(color: Colors.white70, fontSize: 18)),
              const SizedBox(height: 25),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: List.generate(6, (i) => Container(
                  margin: const EdgeInsets.all(6),
                  width: 15, height: 15,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle, 
                    color: i < pin.length ? Colors.red : Colors.white10,
                    border: Border.all(color: Colors.red.withOpacity(0.3))
                  ),
                )),
              ),
              const SizedBox(height: 50),
              GridView.count(
                shrinkWrap: true, crossAxisCount: 3, 
                padding: const EdgeInsets.symmetric(horizontal: 60),
                childAspectRatio: 1.4, physics: const NeverScrollableScrollPhysics(),
                children: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "C", "0", "⌫"].map((e) => InkWell(
                  onTap: () {
                    if (e == "C") setState(() => pin = "");
                    else if (e == "⌫") { if (pin.isNotEmpty) setState(() => pin = pin.substring(0, pin.length - 1)); }
                    else if (e != "") _addDigit(e);
                  },
                  child: Center(child: Text(e, style: const TextStyle(fontSize: 26, color: Colors.red, fontWeight: FontWeight.bold))),
                )).toList(),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// --- لوحة التحكم (الرادار واللاسلكي والخرائط) ---
class HunterDashboard extends StatefulWidget {
  const HunterDashboard({super.key});
  @override
  State<HunterDashboard> createState() => _HunterDashboardState();
}

class _HunterDashboardState extends State<HunterDashboard> with TickerProviderStateMixin {
  bool isPTT = false;
  late AnimationController _radarCtrl;

  @override
  void initState() {
    super.initState();
    _radarCtrl = AnimationController(vsync: this, duration: const Duration(seconds: 4))..repeat();
  }

  @override
  void dispose() {
    _radarCtrl.dispose();
    super.dispose();
  }

  Future<void> _openURL(String url) async {
    final Uri uri = Uri.parse(url);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      debugPrint("خطأ في تشغيل الرابط");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.black,
        title: const Text("رادار الصياد الحقيقي", style: TextStyle(color: Colors.orangeAccent, fontWeight: FontWeight.bold)),
        centerTitle: true,
        actions: [
          IconButton(
            icon: const Icon(Icons.shopping_cart, color: Colors.amber, size: 30),
            onPressed: () => _openURL('https://alsyyad.com/ar'),
          ),
        ],
      ),
      body: Column(
        children: [
          _displayFrequency(),
          _displayRadar(),
          _displayReturnBtn(),
          _displayBottomMenu(),
        ],
      ),
    );
  }

  Widget _displayFrequency() => Container(
    margin: const EdgeInsets.symmetric(vertical: 15),
    padding: const EdgeInsets.symmetric(vertical: 10, horizontal: 50),
    decoration: BoxDecoration(color: const Color(0xFFC5D9A5), borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.black, width: 2)),
    child: Text(isPTT ? "إرسـال حـي" : "144.500 MHz", style: const TextStyle(color: Colors.black, fontSize: 24, fontWeight: FontWeight.bold, fontFamily: 'monospace')),
  );

  Widget _displayRadar() => Expanded(
    child: Container(
      margin: const EdgeInsets.symmetric(horizontal: 20),
      decoration: BoxDecoration(color: Colors.black, borderRadius: BorderRadius.circular(35), border: Border.all(color: Colors.green.withOpacity(0.1))),
      child: Stack(
        alignment: Alignment.center,
        children: [
          RotationTransition(
            turns: _radarCtrl,
            child: Container(decoration: BoxDecoration(shape: BoxShape.circle, gradient: SweepGradient(colors: [Colors.transparent, isPTT ? Colors.red.withOpacity(0.3) : Colors.green.withOpacity(0.3), Colors.transparent]))),
          ),
          const Icon(Icons.navigation, color: Colors.orangeAccent, size: 50),
          Positioned(
            bottom: 25, right: 25,
            child: GestureDetector(
              onLongPress: () => _openURL('https://wa.me/?text=فزعة!_أنا_أحتاج_مساعدة_طارئة'),
              child: Container(
                padding: const EdgeInsets.all(20),
                decoration: const BoxDecoration(color: Colors.red, shape: BoxShape.circle, boxShadow: [BoxShadow(color: Colors.redAccent, blurRadius: 20)]),
                child: const Text("فزعة", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 12)),
              ),
            ),
          ),
        ],
      ),
    ),
  );

  Widget _displayReturnBtn() => Padding(
    padding: const EdgeInsets.symmetric(vertical: 20),
    child: ElevatedButton.icon(
      style: ElevatedButton.styleFrom(backgroundColor: Colors.white10, padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 15)),
      onPressed: () {},
      icon: const Icon(Icons.history, color: Colors.orangeAccent),
      label: const Text("ارجع من حيث ما انطلقت", style: TextStyle(color: Colors.white)),
    ),
  );

  Widget _displayBottomMenu() => Container(
    padding: const EdgeInsets.only(bottom: 40),
    child: Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: [
        _iconBtn(Icons.near_me, "اتجه إلي", Colors.blue, () => _openURL('https://maps.google.com')),
        _buildMic(),
        _iconBtn(Icons.map, "المسار", Colors.green, () {}),
      ],
    ),
  );

  Widget _iconBtn(IconData icon, String label, Color color, VoidCallback action) => InkWell(
    onTap: action,
    child: Column(children: [Icon(icon, color: color, size: 35), const SizedBox(height: 5), Text(label, style: const TextStyle(fontSize: 12))]),
  );

  Widget _buildMic() => GestureDetector(
    onTapDown: (_) => setState(() => isPTT = true),
    onTapUp: (_) => setState(() => isPTT = false),
    child: CircleAvatar(
      radius: 42,
      backgroundColor: isPTT ? Colors.red : Colors.redAccent,
      child: Icon(isPTT ? Icons.settings_voice : Icons.mic, size: 45, color: Colors.white),
    ),
  );
}
